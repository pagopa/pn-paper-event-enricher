AWSTemplateFormatVersion: '2010-09-09'
Description: CodeBuild project to run JS script from GitHub

Resources:

  Con020KmsBucket:
    Type: 'AWS::KMS::Key'
    Properties:
      Description: "Symmetric Encryption KMS for CON020's Buckets"
      KeySpec: SYMMETRIC_DEFAULT
      KeyUsage: ENCRYPT_DECRYPT
      EnableKeyRotation: true
      KeyPolicy:
        Version: 2012-10-17
        Statement:
          - Sid: Enable Permissions on all user and roles
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain

  Con020InputBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${AWS::StackName}-con020-input-bucket-${Env}"
      AccessControl: Private
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - BucketKeyEnabled: true
            ServerSideEncryptionByDefault:
              SSEAlgorithm: 'aws:kms'
              KMSMasterKeyID: !GetAtt Con020KmsBucket.Arn
  Con020OutputBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${AWS::StackName}-con020-output-bucket-${Env}"
      AccessControl: Private
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - BucketKeyEnabled: true
            ServerSideEncryptionByDefault:
              SSEAlgorithm: 'aws:kms'
              KMSMasterKeyID: !GetAtt Con020KmsBucket.Arn

  CodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CodeBuildS3Policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt Con020InputBucket.Arn
                  - !Sub "${Con020InputBucket.Arn}/*"
                  - !GetAtt Con020OutputBucket.Arn
                  - !Sub "${Con020OutputBucket.Arn}/*"
        - PolicyName: CodeBuildDynamoDBPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource:
                  - !Ref NotificationsDynamoTableArn
        - PolicyName: CodeBuildCloudWatchLogsPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - arn:aws:logs:*:*:log-group:/aws/codebuild/*
                  - arn:aws:logs:*:*:log-group:/aws/codebuild/*:*
        - PolicyName: CodeBuildEC2Permissions
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ec2:CreateNetworkInterface
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DeleteNetworkInterface
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeSubnets
                  - ec2:DescribeVpcs
                  - ec2:AttachNetworkInterface
                  - ec2:DetachNetworkInterface
                  - ec2:ModifyNetworkInterfaceAttribute
                  - ec2:DescribeDhcpOptions
                  - ec2:DescribeRouteTables
                  - ec2:DescribeVpcAttribute
                  - ec2:DescribeVpcEndpoints
                  - ec2:CreateNetworkInterfacePermission
                  - ec2:DeleteNetworkInterfacePermission
                  - ec2:DescribeNetworkInterfacePermissions
                Resource: '*'

  Con020CodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: CreateZipCon020
      Source:
        Type: GITHUB
        Location: https://github.com/pagopa/pn-paper-event-enricher.git
        BuildSpec: scripts/create-zip-con020/aws/cfn/buildspec.yml
        ReportBuildStatus: true
#      SourceVersion: feature/PN-12699
      SourceVersion: main
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:6.0
        Type: LINUX_CONTAINER
        EnvironmentVariables:
          - Name: PA_ID
            Value: !Ref PaId
          - Name: BUCKET_SOURCE
            Value: !Ref BucketSource
          - Name: S3_KEY_SOURCE
            Value: !Ref S3KeySource
          - Name: BUCKET_DESTINATION
            Value: !Ref BucketDestination
          - Name: SAFESTORAGE_URL
            Value: !Ref SafeStorageUrl
      ServiceRole: !GetAtt CodeBuildRole.Arn
      Artifacts:
        Type: NO_ARTIFACTS
      VpcConfig:
        VpcId: !Ref VpcId
        Subnets: !Ref Subnets
        SecurityGroupIds: !Ref SecurityGroupIds

Parameters:
  PaId:
    Type: String
    Description: "PA ID"
    Default: ""
  BucketSource:
    Type: String
    Description: "Bucket S3 di input"
    Default: ""
  S3KeySource:
    Type: String
    Description: "Key del file S3"
    Default: ""
  BucketDestination:
    Type: String
    Description: "Bucket S3 di output"
    Default: ""
  SafeStorageUrl:
    Type: String
    Description: "Safe Storage URL"
    Default: ""
  VpcId:
    Type: String
    Description: ID della VPC
  Subnets:
    Type: CommaDelimitedList
    Description: Lista dei subnet per la VPC
  SecurityGroupIds:
    Type: CommaDelimitedList
    Description: Security group per CodeBuild
  NotificationsDynamoTableArn:
    Type: String
    Description: Arn della tabella pn-Notifications
  Env:
    Type: String
    Description: Ambiente su cui eseguire il CloudFormation
    AllowedValues:
      - 'dev'
      - 'test'
      - 'uat'
      - 'prod'
      - 'hotfix'

Outputs:
  CodeBuildProjectName:
    Value: !Ref Con020CodeBuildProject
    Description: "Nome del progetto CodeBuild"
  Con020InputBucket:
    Value: !Ref Con020InputBucket
    Description: "Nome bucket di input dove leggere i dump"
  Con020OutputBucket:
    Value: !Ref Con020OutputBucket
    Description: "Nome bucket di output dove esportare lo zip"
